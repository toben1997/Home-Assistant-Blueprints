blueprint:
  name: ToDo » Zwei Listen in Ziel-Liste zusammenführen (mit optionalen Infos)
  description: >
    Führt alle offenen Einträge aus zwei To-do-Listen in einer Ziel-Liste zusammen.
    Optional: Info im Ziel ("(info: von <Liste>)"), Info-Notiz in den Quelllisten
    (als erledigter Eintrag) und/oder Quell-Items als erledigt markieren.
    Deduplication ohne Groß-/Kleinschreibung. Triggert bei Änderungen an A oder B.
  domain: automation
  input:
    source_a:
      name: Quell-Liste A
      selector:
        entity:
          domain: todo
    source_b:
      name: Quell-Liste B
      selector:
        entity:
          domain: todo
    target_list:
      name: Ziel-Liste
      selector:
        entity:
          domain: todo
    delay_seconds:
      name: Verzögerung nach Änderung (Sek.)
      default: 10
      selector:
        number:
          min: 0
          max: 3600
          unit_of_measurement: s
          mode: slider
          step: 1
    add_info_target:
      name: Info im Zieltitel anhängen
      description: Hängt "(info: von <Quellliste>)" an den Titel in der Ziel-Liste an.
      default: true
      selector:
        boolean: {}
    add_info_sources:
      name: Info-Notiz in Quelllisten anlegen
      description: Legt eine kurze Notiz "[info] verschoben zu <Zielliste>: <Titel>" an und hakt sie direkt ab.
      default: true
      selector:
        boolean: {}
    mark_completed:
      name: Quell-Items als erledigt markieren
      description: Setzt die verschobenen Einträge in den Quelllisten auf "completed".
      default: true
      selector:
        boolean: {}

mode: single

triggers:
  - platform: state
    entity_id:
      - !input source_a
      - !input source_b

conditions: []

actions:
  # Verzögerung
  - delay:
      seconds: !input delay_seconds

  # Bequeme Variablen
  - variables:
      src_a: !input source_a
      src_b: !input source_b
      tgt: !input target_list
      opt_info_target: !input add_info_target
      opt_info_sources: !input add_info_sources
      opt_mark_completed: !input mark_completed

      src_a_name: "{{ state_attr(src_a, 'friendly_name') }}"
      src_b_name: "{{ state_attr(src_b, 'friendly_name') }}"
      tgt_name: "{{ state_attr(tgt, 'friendly_name') }}"

  # Einträge laden (nur offene)
  - service: todo.get_items
    target: { entity_id: !input source_a }
    data: { status: needs_action }
    response_variable: resp_a
  - service: todo.get_items
    target: { entity_id: !input source_b }
    data: { status: needs_action }
    response_variable: resp_b
  - service: todo.get_items
    target: { entity_id: !input target_list }
    data: { status: needs_action }
    response_variable: resp_c

  - variables:
      items_a: "{{ resp_a[src_a]['items'] | default([], true) }}"
      items_b: "{{ resp_b[src_b]['items'] | default([], true) }}"
      tgt_items: "{{ resp_c[tgt]['items'] | default([], true) }}"
      tgt_summaries: "{{ tgt_items | map(attribute='summary') | map('trim') | map('lower') | list }}"

  # Nur weitermachen, wenn in A oder B etwas offen ist
  - condition: template
    value_template: "{{ (items_a|count>0) or (items_b|count>0) }}"

  # ===== Liste A -> Ziel =====
  - repeat:
      for_each: "{{ items_a }}"
      sequence:
        - variables:
            item_text: "{{ repeat.item.summary | trim }}"
            target_title: >
              {% if opt_info_target %}
                {{ item_text }} (info: von {{ src_a_name }})
              {% else %}
                {{ item_text }}
              {% endif %}
        # In Ziel-Liste schreiben (ohne Duplikate)
        - if:
            - condition: template
              value_template: "{{ (item_text|lower) not in tgt_summaries }}"
          then:
            - service: todo.add_item
              data:
                entity_id: "{{ tgt }}"
                item: "{{ target_title }}"
        # Optionale Info-Notiz in Quelle A
        - choose:
            - conditions:
                - condition: template
                  value_template: "{{ opt_info_sources }}"
              sequence:
                - variables:
                    note_text: "[info] verschoben zu {{ tgt_name }}: {{ item_text }}"
                - service: todo.add_item
                  data:
                    entity_id: "{{ src_a }}"
                    item: "{{ note_text }}"
                # UID der Notiz ermitteln und direkt abhaken (falls gefunden)
                - service: todo.get_items
                  target: { entity_id: "{{ src_a }}" }
                  data: { status: needs_action }
                  response_variable: a_after_note
                - variables:
                    note_uid: >
                      {{ (a_after_note[src_a]['items'] | default([], true)
                          | selectattr('summary','equalto', note_text)
                          | map(attribute='uid') | list | first) }}
                - if:
                    - condition: template
                      value_template: "{{ note_uid is string }}"
                  then:
                    - service: todo.update_item
                      data:
                        entity_id: "{{ src_a }}"
                        item: "{{ note_uid }}"
                        status: completed
        # Original-Item als erledigt markieren (optional)
        - choose:
            - conditions:
                - condition: template
                  value_template: "{{ opt_mark_completed }}"
              sequence:
                - service: todo.update_item
                  data:
                    entity_id: "{{ src_a }}"
                    item: "{{ repeat.item.uid }}"
                    status: completed

  # ===== Liste B -> Ziel =====
  - repeat:
      for_each: "{{ items_b }}"
      sequence:
        - variables:
            item_text: "{{ repeat.item.summary | trim }}"
            target_title: >
              {% if opt_info_target %}
                {{ item_text }} (info: von {{ src_b_name }})
              {% else %}
                {{ item_text }}
              {% endif %}
        # In Ziel-Liste schreiben (ohne Duplikate)
        - if:
            - condition: template
              value_template: "{{ (item_text|lower) not in tgt_summaries }}"
          then:
            - service: todo.add_item
              data:
                entity_id: "{{ tgt }}"
                item: "{{ target_title }}"
        # Optionale Info-Notiz in Quelle B
        - choose:
            - conditions:
                - condition: template
                  value_template: "{{ opt_info_sources }}"
              sequence:
                - variables:
                    note_text: "[info] verschoben zu {{ tgt_name }}: {{ item_text }}"
                - service: todo.add_item
                  data:
                    entity_id: "{{ src_b }}"
                    item: "{{ note_text }}"
                - service: todo.get_items
                  target: { entity_id: "{{ src_b }}" }
                  data: { status: needs_action }
                  response_variable: b_after_note
                - variables:
                    note_uid: >
                      {{ (b_after_note[src_b]['items'] | default([], true)
                          | selectattr('summary','equalto', note_text)
                          | map(attribute='uid') | list | first) }}
                - if:
                    - condition: template
                      value_template: "{{ note_uid is string }}"
                  then:
                    - service: todo.update_item
                      data:
                        entity_id: "{{ src_b }}"
                        item: "{{ note_uid }}"
                        status: completed
        # Original-Item als erledigt markieren (optional)
        - choose:
            - conditions:
                - condition: template
                  value_template: "{{ opt_mark_completed }}"
              sequence:
                - service: todo.update_item
                  data:
                    entity_id: "{{ src_b }}"
                    item: "{{ repeat.item.uid }}"
                    status: completed
